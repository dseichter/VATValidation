name: Build Binaries

on:
    push:
      tags:
        - 'v*'

    workflow_dispatch:

jobs:

  build-windows-binary:
      runs-on: windows-latest
      steps:

          - name: 'Checkout'
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

          - name: Set up Python
            uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
            with:
              python-version: 3.14

          - name: Create and start virtual environment
            run: |
              python3 -m venv venv
              venv\Scripts\activate.bat

          - name: Install dependencies
            run: pip install -r src/requirements.txt

          - name: Build Windows binary
            run: pyinstaller --onefile -w src/vatvalidation.py -n VATValidation-windows-${{ github.ref_name }}.exe --icon=icons/vatvalidation.ico

          - name: Upload artifact
            uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v6
            with:
                  name: VATValidation-windows-${{ github.ref_name }}.exe
                  path: dist/VATValidation-windows-${{ github.ref_name }}.exe

  build-windows-binary-cli:
    runs-on: windows-latest
    steps:

        - name: 'Checkout'
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

        - name: Set up Python
          uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
          with:
            python-version: 3.14

        - name: Create and start virtual environment
          run: |
            python3 -m venv venv
            venv\Scripts\activate.bat

        - name: Remove PySide6 dependencies from requirements
          run: |
            type src\requirements.txt | findstr /v "PySide6" >> src\requirements_new.txt
            del src\requirements.txt
            ren src\requirements_new.txt requirements.txt

        - name: Install dependencies
          run: pip install -r src/requirements.txt

        - name: Build Windows binary
          run: pyinstaller --onefile src/vatvalidation_cli.py -n VATValidation-cli-windows-${{ github.ref_name }}.exe

        - name: Upload artifact
          uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v6
          with:
                name: VATValidation-cli-windows-${{ github.ref_name }}.exe
                path: dist/VATValidation-cli-windows-${{ github.ref_name }}.exe      
                
  test-cli-windows:
    runs-on: windows-latest
    needs: [build-windows-binary-cli]
    steps:

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-cli-windows-${{ github.ref_name }}.exe

        - name: Run tests
          shell: cmd
          run: |
            VATValidation-cli-windows-${{ github.ref_name }}.exe --version

  build-linux-binary:
      runs-on: ubuntu-latest
      steps:

          - name: 'Checkout'
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

          - name: Update system packages
            run: sudo apt-get update

          - name: Set up Python
            uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
            with:
              python-version: 3.14

          - name: Create and start virtual environment
            run: |
              python3 -m venv venv
              source venv/bin/activate

          - name: Install dependencies
            run: pip install -r src/requirements.txt

          - name: Build Linux binary
            run: pyinstaller --onefile src/vatvalidation.py -n VATValidation-linux-${{ github.ref_name }}

          - name: Upload artifact
            uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v6
            with:
              name: VATValidation-linux-${{ github.ref_name }}
              path: dist/VATValidation-linux-${{ github.ref_name }}

  build-linux-binary-cli:
    runs-on: ubuntu-latest
    steps:

        - name: 'Checkout'
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

        - name: Update system packages
          run: sudo apt-get update          

        - name: Set up Python
          uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
          with:
            python-version: 3.14

        - name: Create and start virtual environment
          run: |
            python3 -m venv venv
            source venv/bin/activate

        - name: Remove PySide6 from requirements
          run: sed -i '/PySide6/d' src/requirements.txt

        - name: Install dependencies
          run: pip install -r src/requirements.txt

        - name: Build Linux binary
          run: pyinstaller --onefile src/vatvalidation_cli.py -n VATValidation-cli-linux-${{ github.ref_name }}

        - name: Upload artifact
          uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v6
          with:
            name: VATValidation-cli-linux-${{ github.ref_name }}
            path: dist/VATValidation-cli-linux-${{ github.ref_name }}              

  test-cli-linux:
    runs-on: ubuntu-latest
    needs: [build-linux-binary-cli]
    steps:

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-cli-linux-${{ github.ref_name }}

        - name: Run tests
          run: |
            chmod +x VATValidation-cli-linux-${{ github.ref_name }}
            ./VATValidation-cli-linux-${{ github.ref_name }} --version

  deploy:
    runs-on: ubuntu-latest
    needs: [build-windows-binary, build-linux-binary, test-cli-windows, test-cli-linux]
    steps:
        - name: Checkout
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6
          with:
            fetch-depth: 0
            
        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-linux-${{ github.ref_name }}

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-cli-linux-${{ github.ref_name }}            

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-windows-${{ github.ref_name }}.exe

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v7
          with:
            name: VATValidation-cli-windows-${{ github.ref_name }}.exe            

        - name: Generate Release Notes
          id: release_notes
          run: |
            # Get commits since last tag
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              COMMITS=$(git log --pretty=format:"* %s by @%an in %H" --no-merges)
            else
              COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"* %s by @%an in %H" --no-merges)
            fi
            
            # Separate dependabot and regular changes
            DEPENDABOT_CHANGES=$(echo "$COMMITS" | grep -i "dependabot" || true)
            OTHER_CHANGES=$(echo "$COMMITS" | grep -v -i "dependabot" || true)
            
            # Build release notes
            RELEASE_NOTES="## What's Changed\n"
            if [ ! -z "$OTHER_CHANGES" ]; then
              RELEASE_NOTES="${RELEASE_NOTES}${OTHER_CHANGES}\n\n"
            fi
            
            if [ ! -z "$DEPENDABOT_CHANGES" ]; then
              RELEASE_NOTES="${RELEASE_NOTES}## Dependency Updates\n${DEPENDABOT_CHANGES}\n\n"
            fi
            
            RELEASE_NOTES="${RELEASE_NOTES}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...${{ github.ref_name }}"
            
            # Save to output
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

        - name: Create Release
          id: create_release
          uses: softprops/action-gh-release@7b4da11513bf3f43f9999e90eabced41ab8bb048 # v2.5.0
          with:
            tag_name: ${{ github.ref_name }}
            name: Release ${{ github.ref_name }}
            body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
            draft: false
            prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') }}
            files: |
              VATValidation-linux-${{ github.ref_name }}
              VATValidation-windows-${{ github.ref_name }}.exe
              VATValidation-cli-linux-${{ github.ref_name }}
              VATValidation-cli-windows-${{ github.ref_name }}.exe              